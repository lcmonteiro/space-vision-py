# #################################################################################################
# ---------------------------------------------------------------------------------------
# File:   vision_robot_server.py
# Author: Luis Monteiro
#
# Created on nov 8, 2019, 22:00 PM
# ---------------------------------------------------------------------------------------
# #################################################################################################

# #################################################################################################
# ---------------------------------------------------------------------------------------
# imports
# ---------------------------------------------------------------------------------------
# #################################################################################################

# extern
from logging           import getLogger          as logger
from yaml              import safe_load          as loader
from robotremoteserver import RobotRemoteServer 
from threading         import Thread

# local
from .vision_robot_api import VisionApi
# #################################################################################################
# ---------------------------------------------------------------------------------------
# main
# ---------------------------------------------------------------------------------------
# #################################################################################################
def main(ip, port, config):
    # Initialization API 
    api = VisionApi(loader(open(config)))
    # cretate robot remote server
    svr = RobotRemoteServer(api, host=ip, port=port, serve=False)
    # start server
    Thread(target=svr.serve, name='vision_server', daemon=True).start()
    # tool start
    api.serve()

# #################################################################################################
# ---------------------------------------------------------------------------------------
# entry point
# ---------------------------------------------------------------------------------------
# #################################################################################################  
if __name__ == '__main__':
    from argparse import ArgumentParser
    from logging  import basicConfig     as config_logger
    from logging  import DEBUG           as LEVEL
    from os.path  import abspath, dirname
    from sys      import stdout
    # -----------------------------------------------------------------------------------
    # parse parameters
    # -----------------------------------------------------------------------------------
    parser = ArgumentParser()
    parser.add_argument('--ip',
        type    = str, 
        default = '127.0.0.1',
        help    = 'IP address')
    parser.add_argument('--port',
        type    = int, 
        default = 20010,
        help    = 'TCP port')
    parser.add_argument('--config',
        type    =str, 
        default = '%s/vision_robot_config.yaml'%(dirname(abspath(__file__))),
        help    = 'configuration file path')
    args = parser.parse_args()

    # -----------------------------------------------------------------------------------
    # log configuration
    # -----------------------------------------------------------------------------------
    config_logger(
        stream  = stdout,
        filemode= 'w',
        #level   = DEBUG, 
        level   = LEVEL, 
        #filename= 'vision.log', 
        format  = '[%(asctime)s] [%(levelname)-10s] [%(funcName)s] %(message)s')

    # -----------------------------------------------------------------------------------
    # main 
    # -----------------------------------------------------------------------------------
    try:
        exit(main(**vars(args)))
    except Exception as e:
        logger().exception(e)
        exit(-1)
    except KeyboardInterrupt:
        exit(0)
# #################################################################################################
# ---------------------------------------------------------------------------------------
# end
# ---------------------------------------------------------------------------------------
# #################################################################################################  