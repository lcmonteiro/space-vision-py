###################################################################################################
# ---------------------------------------------------------------------------------------
# File:   vision_robot_api.py
# Author: Luis Monteiro
#
# Created on nov 8, 2019, 22:00 PM
# ---------------------------------------------------------------------------------------
###################################################################################################

# external
from re        import match
from time      import time, sleep 
from logging   import getLogger  as logger
from threading import Thread

# internal
from vision.library         import VisionDetector
from vision.library         import VisionDatabase
from vision.library.inputs  import CameraInput
from vision.library.outputs import WindowOutput

# queries
from vision.library.queries import FindTextQuery

###################################################################################################
# ---------------------------------------------------------------------------------------
# Vision API
# ---------------------------------------------------------------------------------------
###################################################################################################
class VisionApi(object):    
    # -----------------------------------------------------------------------------------
    #  initialization
    # -----------------------------------------------------------------------------------
    def __init__(self, config):
        super().__init__()
        # init variables
        self.__logger   = logger()
        self.__detector = VisionDetector(config, CameraInput(), WindowOutput())
        self.__database = VisionDatabase()
        # queries
        self.__find_text = FindTextQuery(self.__database)

    # -----------------------------------------------------------------------------------
    #  serve
    # -----------------------------------------------------------------------------------
    def serve(self):
        @self.__detector.serve
        def process(id, results):
            self.__database.insert(id, results)


    # -----------------------------------------------------------------------------------
    #  enable a filter
    # -----------------------------------------------------------------------------------
    def set_filter(self, name):  
        self.__detector.set_filter(name)
    
    # -----------------------------------------------------------------------------------
    #  disable all filters
    # -----------------------------------------------------------------------------------
    def clear_filters(self):  
        self.__detector.clr_filters()

    # -----------------------------------------------------------------------------------
    #  clear database
    # -----------------------------------------------------------------------------------
    def clear_variables(self):  
        self.__database = {}

    # -----------------------------------------------------------------------------------
    #  get number variable
    # -----------------------------------------------------------------------------------
    def get_number_variable(self, varname, time_beg, time_end, value_beg, value_end):
        pass
    
    # -----------------------------------------------------------------------------------
    #  get text variable
    # -----------------------------------------------------------------------------------
    def get_text_variable(self, varname, time_beg, time_end, pattern):
        return self.__find_text(varname, (time_beg, time_end), pattern)

###################################################################################################
# ---------------------------------------------------------------------------------------
#   Test
# ---------------------------------------------------------------------------------------
###################################################################################################
if __name__ == '__main__':
    api = VisionApi()
    

###################################################################################################
# ---------------------------------------------------------------------------------------
#   End
# ---------------------------------------------------------------------------------------
###################################################################################################